name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-and-test:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Qt6
      run: |
        brew install qt6
        echo "$(brew --prefix qt6)/bin" >> $GITHUB_PATH
        
    - name: Install dependencies
      run: |
        brew install cmake ninja sqlite3
        
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_PREFIX_PATH=$(brew --prefix qt6)
          
    - name: Build and Verify Zero Warnings
      run: |
        cd build
        ninja -j4 2>&1 | tee build.log
        if grep -E "(warning|error)" build.log; then
          echo "❌ Build contains warnings or errors"
          exit 1
        else
          echo "✅ Perfect clean build - zero warnings, zero errors"
        fi
        
    - name: Run Tests and Verify 100% Success
      run: |
        cd build
        ctest --output-on-failure --verbose | tee test.log
        if ! grep -q "100% tests passed, 0 tests failed out of 10" test.log; then
          echo "❌ Not all tests passing"
          exit 1
        else
          echo "✅ All 10/10 tests passing"
        fi

  lint-and-format:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install clang-format
      run: sudo apt-get install -y clang-format
      
    - name: Check code formatting
      run: |
        find src tests -name "*.cpp" -o -name "*.h" | xargs clang-format --dry-run --Werror
        
    - name: Check CMake formatting
      uses: cheshirekow/cmake-format-precommit@v0.6.13
      with:
        input: CMakeLists.txt

  documentation:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Validate specification compliance
      run: |
        # Ensure all planned artifacts exist
        test -f "specs/001-editor-project-v1/spec.md" || exit 1
        test -f "specs/001-editor-project-v1/plan.md" || exit 1
        test -f "specs/001-editor-project-v1/tasks.md" || exit 1
        test -f "specs/001-editor-project-v1/data-model.md" || exit 1
        test -f "specs/001-editor-project-v1/ui-layout-spec.md" || exit 1

        echo "✅ All specification artifacts present"

    - name: Validate ripple trim constraint system (2025-10-11)
      run: |
        # Ensure ripple trim constraint system files exist
        test -f "src/lua/core/command_manager.lua" || exit 1
        test -f "src/lua/core/timeline_constraints.lua" || exit 1
        test -f "src/lua/core/frame_utils.lua" || exit 1
        test -f "src/lua/ui/timeline/timeline_view.lua" || exit 1

        # Validate that RippleEdit executor exists in command_manager
        grep -q "executors\[\"RippleEdit\"\]" src/lua/core/command_manager.lua || exit 1

        # Validate critical constraint functions exist
        grep -q "function M.calculate_trim_range" src/lua/core/timeline_constraints.lua || exit 1
        grep -q "function M.clamp_trim_delta" src/lua/core/timeline_constraints.lua || exit 1
        grep -q "check_all_tracks" src/lua/core/timeline_constraints.lua || exit 1

        # Validate gap materialization (virtual gap clips)
        grep -q "gap_before" src/lua/core/command_manager.lua || exit 1
        grep -q "gap_after" src/lua/core/command_manager.lua || exit 1

        # Validate coordinate space conversion (shift ↔ delta)
        grep -q "min_shift" src/lua/core/command_manager.lua || exit 1
        grep -q "max_shift" src/lua/core/command_manager.lua || exit 1
        grep -q "min_delta" src/lua/core/command_manager.lua || exit 1
        grep -q "max_delta" src/lua/core/command_manager.lua || exit 1

        # Validate frame snapping
        grep -q "snap_delta_to_frame" src/lua/core/frame_utils.lua || exit 1

        echo "✅ Ripple trim constraint system validated (9 critical bugs fixed)"

    - name: Run ripple operations test suite (2025-10-12)
      run: |
        # Ensure test file exists
        test -f "test_ripple_operations.lua" || exit 1

        # Install LuaJIT
        sudo apt-get update
        sudo apt-get install -y luajit

        # Run test suite
        cd ${{ github.workspace }}
        luajit test_ripple_operations.lua | tee test_output.log

        # Verify all 63 tests pass
        if ! grep -q "Total Tests:  63" test_output.log; then
          echo "❌ Expected 63 tests"
          exit 1
        fi

        if ! grep -q "Passed:       63 (100.0%)" test_output.log; then
          echo "❌ Not all tests passing"
          exit 1
        fi

        if ! grep -q "Failed:       0 (0.0%)" test_output.log; then
          echo "❌ Some tests failed"
          exit 1
        fi

        echo "✅ All 63 ripple operation tests pass (including gap materialization)"

    - name: Validate gap materialization implementation (2025-10-12)
      run: |
        # Validate BatchRippleEdit has correct gap materialization
        grep -q "Create temporary gap clip object" src/lua/core/command_manager.lua || exit 1
        grep -q "temp_gap_" src/lua/core/command_manager.lua || exit 1
        grep -q "is_gap_clip = true" src/lua/core/command_manager.lua || exit 1

        # Ensure gap clips calculate their own boundaries
        grep -q "gap_start = reference_clip.start_time + reference_clip.duration" src/lua/core/command_manager.lua || exit 1
        grep -q "gap_end = math.min(gap_end, c.start_time)" src/lua/core/command_manager.lua || exit 1

        # Verify gap clips aren't saved to database
        grep -q "if not is_gap_clip then" src/lua/core/command_manager.lua || exit 1

        # Ensure documentation exists
        test -f "docs/gap-materialization.md" || exit 1
        test -f "docs/batch-ripple-bugs.md" || exit 1
        test -f "docs/batch-ripple-fixes-summary.md" || exit 1

        echo "✅ Gap materialization implementation validated (Bug #3 fixed)"

    - name: Validate BatchCommand atomic undo system (2025-10-12)
      run: |
        # Validate BatchCommand executor exists
        grep -q "command_executors\[\"BatchCommand\"\]" src/lua/core/command_manager.lua || exit 1

        # Validate BatchCommand undoer exists
        grep -q "command_undoers\[\"BatchCommand\"\]" src/lua/core/command_manager.lua || exit 1

        # Validate JSON parsing for command specs
        grep -q "json.decode(commands_json)" src/lua/core/command_manager.lua || exit 1

        # Validate rollback on failure
        grep -q "Rollback previous commands" src/lua/core/command_manager.lua || exit 1

        # Validate inspector uses BatchCommand for multi-edit
        grep -q "BatchCommand" src/lua/ui/inspector/view.lua || exit 1
        grep -q "command_specs" src/lua/ui/inspector/view.lua || exit 1

        # Validate Delete key uses BatchCommand
        grep -q "BatchCommand" src/lua/core/keyboard_shortcuts.lua || exit 1
        grep -q "single undo" src/lua/core/keyboard_shortcuts.lua || exit 1

        echo "✅ BatchCommand atomic undo system validated (multi-clip operations use single undo entry)"